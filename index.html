<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bussola Universitaria</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß≠</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #4f46e5;
            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text: #1e293b;
            --text-muted: #64748b;
            --radius: 16px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.08);
            --input-bg: rgba(255, 255, 255, 0.8);
            --border-color: rgba(226, 232, 240, 0.8);
            --card-inner-bg: rgba(255, 255, 255, 0.7);
            --winner-bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            --winner-border: #3b82f6;
            --winner-text: #1e3a8a;
            --runner-bg: linear-gradient(135deg, rgba(239, 246, 255, 0.8) 0%, rgba(240, 249, 255, 0.8) 100%);
            --runner-border: #bfdbfe;
            --runner-text: #1e293b;
            --runner-score-bg: #eff6ff;
            --runner-score-text: #1e3a8a;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #818cf8;
                --primary-dark: #6366f1;
                --success: #818cf8;
                --bg: #0f172a;
                --card-bg: rgba(30, 41, 59, 0.85);
                --text: #f1f5f9;
                --text-muted: #94a3b8;
                --input-bg: rgba(30, 41, 59, 0.6);
                --border-color: rgba(71, 85, 105, 0.6);
                --card-inner-bg: rgba(15, 23, 42, 0.8);
                --card-bg: rgba(15, 23, 42, 0.95);
                --winner-bg: linear-gradient(135deg, #1e3a8a 0%, #172554 100%);
                --winner-border: #3b82f6;
                --winner-text: #e0e7ff;
                --runner-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
                --runner-border: #334155;
                --runner-text: #f1f5f9;
                --runner-score-bg: #1e293b;
                --runner-score-text: #e0e7ff;
            }
        }

        .beta-disclaimer {
            background: #ffe4e6;
            border: 2px solid #f43f5e;
            color: #be123c;
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 25px;
            text-align: left;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(244, 63, 94, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            .beta-disclaimer {
                background: rgba(136, 19, 55, 0.3);
                border-color: #fb7185;
                color: #fecdd3;
                box-shadow: none;
            }
        }

        /* Scrollbar personalizzata */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
            box-sizing: border-box;
            /* Prevent padding from adding to width */
        }

        html,
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overscroll-behavior-y: contain;
            /* Previene refresh involontario su mobile */
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        h1 {
            color: var(--text);
            text-align: center;
            margin-top: 0;
            font-weight: 800;
            font-size: 2rem;
            letter-spacing: -0.02em;
        }

        h2 {
            font-size: 1.4em;
            margin-bottom: 0.5em;
            font-weight: 700;
            color: var(--text);
        }

        h5 {
            font-size: 1.05em;
            margin: 15px 0 8px 0;
            color: var(--text);
            font-weight: 600;
        }

        .caption {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: block;
            font-style: italic;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: var(--radius);
            background: var(--card-inner-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(99, 102, 241, 0.3);
        }

        select {
            width: 100%;
            padding: 14px 16px;
            font-size: 1rem;
            font-family: inherit;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }

        select:hover {
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        select:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.4);
        }

        select:focus:not(:focus-visible) {
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Fix per textarea e input nel nuovo form */
        textarea,
        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            font-size: 1rem;
            font-family: inherit;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            transition: all 0.3s ease;
            resize: vertical;
        }

        textarea:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        select option {
            padding: 12px;
            background: var(--card-bg);
            color: var(--text);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Slider wrapper con valore sopra thumb */
        .slider-wrapper {
            position: relative;
            padding-top: 25px;
            margin: 10px 0;
        }

        .slider-wrapper input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
            margin: 0;
        }

        .slider-value {
            position: absolute;
            top: 0;
            color: var(--primary);
            font-size: 0.85em;
            font-weight: 700;
            transform: translateX(-50%);
            pointer-events: none;
            transition: left 0.1s ease;
        }

        .slider-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #94a3b8;
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.3s ease 0.5s;
        }

        .slider-wrapper:hover .slider-range {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
            margin: 10px 0;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 1px 4px rgba(99, 102, 241, 0.3);
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            border: none;
        }

        input[type="range"]::-moz-range-progress {
            height: 6px;
            background: var(--primary);
            border-radius: 3px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 4px rgba(99, 102, 241, 0.3);
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-next {
            background: var(--primary);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-next:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-prev {
            background: var(--input-bg);
            color: var(--text);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-prev:hover {
            background: var(--border-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .radio-option {
            display: block;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            background: var(--input-bg);
            font-weight: 500;
        }

        .radio-option:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateX(4px);
        }

        .radio-option:has(input:checked) {
            background: rgba(99, 102, 241, 0.12);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .slider-numbers {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #94a3b8;
            margin-top: -5px;
            padding: 0 2px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-top: 8px;
            line-height: 1.4;
        }

        .slider-labels span {
            width: 48%;
        }

        .left-label {
            color: #0288d1;
        }

        .right-label {
            color: #2e7d32;
            text-align: right;
        }

        /* Custom Dropdown */
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .dropdown-selected {
            padding: 14px 16px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-selected:hover {
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dropdown-selected.open {
            border-color: var(--primary);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .dropdown-arrow {
            transition: transform 0.3s ease;
            color: var(--primary);
        }

        .dropdown-selected.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            display: none;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-options.show {
            display: block;
        }

        .dropdown-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            padding-left: 20px;
        }

        .dropdown-option.selected {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            font-weight: 600;
        }

        /* Risultati */
        .winner-box {
            /* Blu Vincitore */
            background: var(--winner-bg);
            border: 2px solid var(--winner-border);
            padding: 35px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.25);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .winner-box:hover {
            transform: scale(1.02);
        }

        .winner-name {
            color: var(--winner-text);
            /* Dark Blue */
            font-size: 2rem;
            margin: 12px 0;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .runners-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Default 2 columns */
            gap: 15px;
            margin-top: 20px;
        }

        /* Layout specific overrides */
        .runners-grid.layout-1 {
            grid-template-columns: 1fr;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .runners-grid.layout-3 .runner-card:last-child {
            /* 3 items: 2 top, 1 bottom center */
            grid-column: 1 / -1;
            width: 50%;
            margin: 0 auto;
        }

        @media (max-width: 600px) {
            .runners-grid {
                grid-template-columns: 1fr !important;
            }

            .runners-grid.layout-3 .runner-card:last-child {
                width: 100%;
                /* Reset width on mobile */
            }
        }

        .runner-card {
            /* Azzurro Alternative */
            background: var(--runner-bg);
            border: 1px solid var(--runner-border);
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .runner-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            /* Rimossa background:white su richiesta utente */
        }

        .runner-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--runner-text);
            /* Keep dark text for runner cards as they have light bg */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .runner-score {
            /* Background matches card (Azure) */
            background: var(--runner-score-bg);
            color: var(--runner-score-text);
            /* Dark Blue Text */
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            min-width: 60px;
            text-align: center;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            margin-top: 20px;
            z-index: 1;
        }

        /* Nuovi stili per la griglia universit√† */
        .uni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .uni-card {
            padding: 15px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 1px solid transparent;
            /* Overridden by badge classes */
            position: relative;
            background: var(--card-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 110px;
        }

        .uni-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .uni-link-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.05);
            /* Neutral base */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        /* Colore per card PUBBLICA (Rosso) */
        .badge-pub .uni-link-icon {
            color: #c62828;
            background: rgba(198, 40, 40, 0.1);
        }

        .badge-pub .uni-link-icon:hover {
            background: #c62828;
            color: white;
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
            transform: translate(2px, -2px);
        }

        /* Colore per card PRIVATA (Blu) */
        .badge-priv .uni-link-icon {
            color: #1565c0;
            background: rgba(21, 101, 192, 0.1);
        }

        .badge-priv .uni-link-icon:hover {
            background: #1565c0;
            color: white;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
            transform: translate(2px, -2px);
        }

        .badge-pub {
            background-color: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }

        .badge-priv {
            background-color: #e3f2fd;
            color: #1565c0;
            border-color: #90caf9;
        }

        @media (prefers-color-scheme: dark) {
            .badge-pub {
                background-color: #3b1515;
                color: #ef9a9a;
                border-color: #5c2020;
            }

            .badge-pub .uni-link-icon {
                color: #ef9a9a;
                background: rgba(239, 154, 154, 0.15);
            }

            .badge-priv {
                background-color: #0d2137;
                color: #90caf9;
                border-color: #1a3a5c;
            }

            .badge-priv .uni-link-icon {
                color: #90caf9;
                background: rgba(144, 202, 249, 0.15);
            }
        }

        .badge-text {
            font-size: 0.75em;
            font-weight: bold;
            display: inline-block;
            margin-top: 4px;
            padding: 0;
            background: transparent;
        }

        /* ============================================= */
        /* MOBILE OPTIMIZATION - Target: 480px e sotto  */
        /* ============================================= */
        @media (max-width: 480px) {

            /* Body e container pi√π compatti */
            body {
                padding: 12px 8px;
            }

            .container {
                padding: 20px 16px;
                border-radius: 16px;
            }

            /* Tipografia responsive */
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }

            h2 {
                font-size: 1.15rem;
                margin-top: 20px;
            }

            h5 {
                font-size: 0.95rem;
            }

            .caption {
                font-size: 0.85rem;
            }

            /* Cards pi√π compatte */
            .card {
                padding: 14px;
                margin-bottom: 12px;
            }

            /* Sliders touch-friendly */
            .slider-wrapper {
                padding-top: 28px;
            }

            input[type="range"] {
                height: 24px;
                margin: 8px 0;
            }

            .slider-value {
                font-size: 0.9em;
                font-weight: 800;
            }

            /* Radio/checkbox pi√π grandi per touch */
            .radio-option {
                padding: 14px 16px;
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            /* Dropdown ottimizzato per touch */
            .dropdown-selected {
                padding: 16px;
                font-size: 1rem;
            }

            .dropdown-option {
                padding: 14px 16px;
                font-size: 0.95rem;
            }

            /* Bottoni full-width e impilati */
            .btn-group {
                flex-direction: column;
                gap: 10px;
            }

            .btn-next,
            .btn-prev {
                width: 100%;
                padding: 16px 20px;
                font-size: 1rem;
            }

            /* Slider labels - mantieni affiancate su mobile */
            .slider-labels {
                gap: 8px;
            }

            .left-label,
            .right-label {
                text-align: center;
                font-size: 0.8rem;
                padding: 8px;
                background: rgba(99, 102, 241, 0.05);
                border-radius: 8px;
            }

            /* Risultati pi√π compatti */
            .winner-box {
                padding: 20px 15px;
                width: 100%;
                box-sizing: border-box;
                margin-left: 0;
                margin-right: 0;
            }

            .winner-name {
                font-size: 1.5rem;
                word-wrap: break-word;
                /* Prevent long words from overflowing */
            }

            .runner-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                width: 100%;
                box-sizing: border-box;
            }

            .runner-card {
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            /* Mappa pi√π piccola su mobile */
            #map {
                height: 280px !important;
                margin-top: 15px;
            }

            /* Progress bar indicator */
            #step-indicator {
                font-size: 0.8rem;
            }
        }

        /* Tablet optimization (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            body {
                padding: 20px 15px;
            }

            .container {
                padding: 30px 25px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .btn-group {
                gap: 12px;
            }
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            margin-top: 20px;
            z-index: 1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--card-bg);
            color: var(--text);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            position: relative;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            background: none;
            border: none;
            padding: 5px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }

        .stat-box {
            background: var(--card-inner-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .stat-val {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .source-note {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 15px;
            font-style: italic;
        }

        /* ======================== */
        /* FEEDBACK MODAL STYLES    */
        /* ======================== */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: overlayFadeIn 0.3s ease;
        }

        .feedback-overlay.show {
            display: flex;
        }

        @keyframes overlayFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .feedback-modal {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 35px 30px 30px;
            max-width: 440px;
            width: 100%;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: modalSlideIn 0.4s ease;
        }

        .feedback-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.6rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .feedback-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .feedback-modal h3 {
            margin: 0 0 6px 0;
            font-size: 1.3rem;
            color: var(--text);
        }

        .feedback-modal .feedback-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            direction: rtl;
        }

        .star-rating input[type="radio"] {
            display: none;
        }

        .star-rating label {
            font-size: 2.4rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.15s ease;
            line-height: 1;
        }

        .star-rating label:hover,
        .star-rating label:hover~label,
        .star-rating input:checked~label {
            color: #facc15;
        }

        .star-rating label:hover {
            transform: scale(1.25);
        }

        .feedback-textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 0.95rem;
            font-family: inherit;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text);
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
        }

        .feedback-textarea::placeholder {
            color: var(--text-muted);
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn-feedback {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }

        .btn-feedback:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-feedback:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .feedback-success {
            margin-top: 16px;
            padding: 14px 20px;
            border-radius: 12px;
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            font-weight: 600;
            display: none;
        }

        @media (prefers-color-scheme: dark) {
            .feedback-success {
                background: rgba(34, 197, 94, 0.15);
                color: #4ade80;
            }

            /* Dark mode: chatbot accordion */
            .chat-accordion {
                background: var(--card-inner-bg) !important;
                border-color: var(--border-color) !important;
            }

            .chat-header {
                background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 27, 75, 0.9) 100%) !important;
                border-bottom-color: var(--border-color) !important;
            }

            .chat-header-title {
                color: var(--text) !important;
            }

            .chat-header-subtitle {
                color: var(--text-muted) !important;
            }

            .chat-messages-area {
                background: rgba(15, 23, 42, 0.95) !important;
                border-top-color: var(--border-color) !important;
            }

            .chat-input-area {
                background: var(--card-inner-bg) !important;
                border-top-color: var(--border-color) !important;
            }

            .chat-input-area input {
                background: var(--input-bg) !important;
                color: var(--text) !important;
                border-color: var(--border-color) !important;
            }

            .msg-ai {
                background: rgba(30, 41, 59, 0.9) !important;
                color: var(--text) !important;
                border-color: var(--border-color) !important;
            }

            /* Dark mode: modal content */
            .modal-content h4 {
                color: var(--text-muted) !important;
            }

            .modal-content ul {
                color: var(--text) !important;
            }

            .modal-close {
                color: var(--text-muted);
            }

            /* Dark mode: misc hardcoded text */
            #step-indicator {
                color: var(--text-muted) !important;
            }

            .slider-helper-text {
                color: var(--text-muted) !important;
            }

            .uni-section-heading {
                color: var(--text) !important;
            }

            .container hr {
                border-color: var(--border-color) !important;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>üß≠ Bussola Universitaria</h1>
        <div style="height:4px; background:#e2e8f0; margin-bottom:8px;">
            <div id="progress" style="height:100%; width:0%; background:var(--primary); transition:0.3s;"></div>
        </div>
        <div id="step-indicator" style="text-align:center; font-size:0.9em; color:#64748b; margin-bottom:20px;">Step 1
            di 5</div>

        <div id="step-1" class="step active">
            <div class="beta-disclaimer">
                <strong>‚ö†Ô∏è Disclaimer (Beta):</strong> Il sito √® stato creato per puro scopo indicativo e informativo.
                Essendo in beta potrebbero esserci dei problemi. I dati inseriti vengono salvati (in modo anonimo) per
                migliorare il calcolo dei punteggi grazie ai vostri feedback.
            </div>
            <h2>üè´ Che scuola frequenti?</h2>
            <div class="custom-dropdown" id="school-dropdown">
                <div class="dropdown-selected" onclick="toggleDropdown()">
                    <span id="selected-school">Liceo Scientifico</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="dropdown-options" id="dropdown-options"></div>
            </div>
            <select id="school-select" style="display:none;"></select>
            <h2>üìö I tuoi voti</h2>
            <span class="caption">Inserisci voto e fatica per le tue materie principali.</span>
            <div id="subjects-container" class="grid-2"></div>
            <div class="btn-group">
                <div></div><button class="btn-next" onclick="nextStep(2)">Continua ‚û°Ô∏è</button>
            </div>
        </div>

        <div id="step-2" class="step">
            <h2>üõ§Ô∏è Tu cosa faresti?</h2>

            <div class="card">
                <h5>ü™ê Missione su Marte</h5>
                <span class="caption">Siamo nel 2050, la base spaziale ha un problema. Tu quale ruolo ricopri nel
                    team?</span>
                <div id="q_tech_c"></div>
            </div>

            <div class="card">
                <h5>üèôÔ∏è Il Grattacielo</h5>
                <span class="caption">Sei all'ultimo piano di una multinazionale a New York. Di cosa si occupa il tuo
                    ufficio?</span>
                <div id="q_biz_c"></div>
            </div>

            <div class="card">
                <h5>üî¨ Il Laboratorio di ricerca</h5>
                <span class="caption">Hai la possibilit√† di migliorare la vita sulla Terra. A quale grande progetto ti
                    dedichi?</span>
                <div id="q_sci_c"></div>
            </div>

            <div class="card">
                <h5>üé® L'Atelier Creativo</h5>
                <span class="caption">Il mondo √® troppo grigio. Come decidi di usare il tuo talento per
                    cambiarlo?</span>
                <div id="q_art_c"></div>
            </div>

            <!-- NUOVE DOMANDE INDIRETTE -->
            <div class="card">
                <h5>üì∫ Il Feed di YouTube</h5>
                <span class="caption">Apri YouTube e ti escono questi 5 video. Su quale clicchi?</span>
                <div id="q_youtube_c"></div>
            </div>

            <div class="card">
                <h5>üé¨ Il Ruolo nella Serie TV</h5>
                <span class="caption">Se fossi il protagonista di una serie TV, chi saresti?</span>
                <div id="q_netflix_c"></div>
            </div>

            <div class="card">
                <h5>üöÄ La Startup</h5>
                <span class="caption">Tu e i tuoi amici fondate una Startup. Tu di cosa ti occupi?</span>
                <div id="q_startup_c"></div>
            </div>

            <div class="btn-group"><button class="btn-prev" onclick="nextStep(1)">‚¨ÖÔ∏è Indietro</button><button
                    class="btn-next" onclick="nextStep(3)">Continua ‚û°Ô∏è</button></div>
        </div>

        <div id="step-3" class="step">
            <h2>üß† Come funziona la tua mente?</h2>
            <p>Non rispondere come 'dovresti' essere, ma come ti senti pi√π a tuo agio.</p>

            <div class="card">
                <h5>üîç Quando devi svolgere un compito complesso:</h5>
                <span class="caption">Esempio: Studiare un capitolo difficile.</span>
                <div class="slider-wrapper">
                    <span class="slider-value" id="sv_detail">5</span>
                    <input type="range" id="s_detail" min="0" max="10" value="5"
                        oninput="updateSliderValue(this, 'sv_detail')">
                    <div class="slider-range"><span>0</span><span>10</span></div>
                </div>
                <div class="slider-labels">
                    <span class="left-label">üëà <b>Visione d'insieme</b>: Mi annoiano i dettagli, preferisco capire il
                        concetto generale e improvvisare il resto.</span>
                    <span class="right-label">üëâ <b>Ossessione</b>: Se c'√® un errore o una virgola fuori posto
                        impazzisco. Devo avere tutto sotto controllo.</span>
                </div>
            </div>

            <div class="card">
                <h5>üöÄ Il tuo profilo di rischio:</h5>
                <span class="caption">Cosa ti fa dormire meglio la notte?</span>
                <div class="slider-wrapper">
                    <span class="slider-value" id="sv_risk">5</span>
                    <input type="range" id="s_risk" min="0" max="10" value="5"
                        oninput="updateSliderValue(this, 'sv_risk')">
                    <div class="slider-range"><span>0</span><span>10</span></div>
                </div>
                <div class="slider-labels">
                    <span class="left-label">üëà <b>Stabilit√†</b>: Voglio un percorso chiaro, regole definite e uno
                        stipendio garantito. Odio l'incertezza.</span>
                    <span class="right-label">üëâ <b>Scommessa</b>: La routine mi uccide. Voglio rischiare per ottenere
                        grandi risultati, anche se posso fallire.</span>
                </div>
            </div>

            <div class="card">
                <h5>üó£Ô∏è Le tue batterie sociali:</h5>
                <span class="caption">In quale situazione ti senti pi√π a tuo agio...</span>
                <div class="slider-wrapper">
                    <span class="slider-value" id="sv_people">5</span>
                    <input type="range" id="s_people" min="0" max="10" value="5"
                        oninput="updateSliderValue(this, 'sv_people')">
                    <div class="slider-range"><span>0</span><span>10</span></div>
                </div>
                <div class="slider-labels">
                    <span class="left-label">üëà <b>Autonomia</b>: Preferisco lavorare da solo, concentrato, con le
                        cuffie. La gente mi distrae.</span>
                    <span class="right-label">üëâ <b>Relazione</b>: Ho bisogno di parlare, confrontarmi e stare con le
                        persone. Il silenzio mi pesa.</span>
                </div>
            </div>

            <div class="card">
                <h5>üõ†Ô∏è Cosa ti d√† pi√π soddisfazione?</h5>
                <span class="caption">Quando impari qualcosa di nuovo...</span>
                <div class="slider-wrapper">
                    <span class="slider-value" id="sv_abs">5</span>
                    <input type="range" id="s_abs" min="0" max="10" value="5"
                        oninput="updateSliderValue(this, 'sv_abs')">
                    <div class="slider-range"><span>0</span><span>10</span></div>
                </div>
                <div class="slider-labels">
                    <span class="left-label">üëà <b>Il Risultato</b>: Voglio vedere a cosa serve. Voglio costruire,
                        curare, toccare con mano il risultato.</span>
                    <span class="right-label">üëâ <b>Il Concetto</b>: Mi piace capire il 'perch√©' profondo delle cose, la
                        teoria, le idee astratte e i sistemi.</span>
                </div>
            </div>

            <div class="btn-group"><button class="btn-prev" onclick="nextStep(2)">‚¨ÖÔ∏è Indietro</button><button
                    class="btn-next" onclick="nextStep(4)">Continua ‚û°Ô∏è</button></div>
        </div>

        <div id="step-4" class="step">
            <h2>‚ö° Scenari di vita reale</h2>

            <div class="card">
                <h5>üì¶ Trovi un vecchio oggetto che non funziona pi√π</h5>
                <div id="q_broken_c"></div>
            </div>

            <div class="card">
                <h5>üîÆ Dove ti vedi tra 10 anni?</h5>
                <div id="q_future_c"></div>
            </div>

            <div class="btn-group"><button class="btn-prev" onclick="nextStep(3)">‚¨ÖÔ∏è Indietro</button><button
                    class="btn-next" onclick="nextStep(5)">Continua ‚û°Ô∏è</button></div>
        </div>

        <div id="step-5" class="step">
            <h2>üåç Ultime conferme</h2>
            <span class="caption">Seleziona tutte le opzioni che pensi ti descrivano</span>
            <div class="grid-2" id="chk_container"></div>
            <div class="btn-group"><button class="btn-prev" onclick="nextStep(4)">‚¨ÖÔ∏è Indietro</button><button
                    class="btn-next" style="background:var(--success)" onclick="calculateAndShow()">üîÆ CALCOLA IL MIO
                    FUTURO</button></div>
        </div>

        <div id="step-6" class="step">
            <div class="winner-box" onclick="openModal(document.getElementById('w_name').innerText)"
                style="cursor:pointer;">
                <div style="color:#15803d; text-transform:uppercase; font-size:0.9em;">Consiglio</div>
                <div class="winner-name" id="w_name">...</div>
                <div id="w_score">Punteggio: 0</div>
            </div>
            <h3>üí° Alternative:</h3>
            <div class="runners-grid" id="runners"></div>
            <hr>
            <h3>üìä Il tuo profilo universitario:</h3>
            <div id="chart-container" style="padding: 20px 0; height: 300px; transition: height 0.3s ease;"><canvas
                    id="radarChart"></canvas></div>
            <button id="toggle-chart-btn" class="btn-prev" style="width:100%; margin-bottom:20px;"
                onclick="toggleChartView()">Mostra tutte le facolt√†</button>
            <hr>
            <h3>üìç Dove studiare?</h3>
            <div class="custom-dropdown" id="map-dropdown">
                <div class="dropdown-selected" onclick="toggleMapDropdown()">
                    <span id="selected-faculty">Seleziona facolt√†</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="dropdown-options" id="map-dropdown-options"></div>
            </div>
            <select id="map-select" style="display:none;"></select>

            <div id="map"></div>
            <div id="unis-list-container"></div>
            <div class="btn-group"><button class="btn-prev" onclick="window.scrollTo(0,0); location.reload()">üîÑ
                    Ricomincia</button></div>

            <!-- CHATBOT ACCORDION START -->
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">

            <div style="border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; margin-bottom: 30px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.02);"
                class="chat-accordion">
                <div onclick="toggleChatAccordion()"
                    style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid transparent; transition: all 0.2s;"
                    class="chat-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 24px;">ü§ñ</span>
                        <div>
                            <div style="font-weight: 700; color: #1e293b; font-size: 1.1rem;" class="chat-header-title">
                                Tutor Orientamento AI ‚ú®
                            </div>
                            <div style="color: #64748b; font-size: 0.9rem;" class="chat-header-subtitle">Dubbi sui
                                risultati? Chiedimi un consiglio!
                            </div>
                        </div>
                    </div>
                    <span id="chat-arrow"
                        style="font-size: 1.2rem; color: #64748b; transition: transform 0.3s ease;">‚ñº</span>
                </div>

                <div id="chat-accordion-content"
                    style="display: none; height: 0; transition: height 0.3s ease; flex-direction: column;">
                    <div id="chat-messages"
                        style="height: 350px; padding: 20px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #e2e8f0;"
                        class="chat-messages-area">
                        <div class="msg-ai"
                            style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 0; align-self: flex-start; max-width: 85%; font-size: 0.95rem; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                            Ciao! üëã Ho visto i tuoi risultati. Hai dubbi su qualche facolt√† o vuoi un consiglio?
                        </div>
                    </div>

                    <div style="padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; align-items: center;"
                        class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Scrivi la tua domanda..."
                            onkeypress="handleEnter(event)"
                            style="flex: 1; border: 1px solid #cbd5e1; padding: 12px 16px; border-radius: 24px; outline: none; font-size: 0.95rem; transition: border-color 0.2s;">
                        <button onclick="sendMessage()"
                            style="background: #6366f1; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);">
                            <span style="font-size: 1.2rem; margin-left: 2px;">‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- CHATBOT ACCORDION END -->
        </div>
    </div>

    </div>

    <!-- FEEDBACK MODAL OVERLAY (fuori dal container) -->
    <div id="feedback-overlay" class="feedback-overlay">
        <div class="feedback-modal">
            <button class="feedback-close" onclick="closeFeedback()" title="Chiudi">√ó</button>
            <h3>üöÄ Aiutaci a migliorare</h3>
            <p class="feedback-subtitle">Quanto sei soddisfatto dei risultati? Dai un voto!</p>

            <div class="star-rating">
                <input type="radio" name="fb_rating" id="star5" value="5">
                <label for="star5" title="5 stelle">‚òÖ</label>
                <input type="radio" name="fb_rating" id="star4" value="4">
                <label for="star4" title="4 stelle">‚òÖ</label>
                <input type="radio" name="fb_rating" id="star3" value="3">
                <label for="star3" title="3 stelle">‚òÖ</label>
                <input type="radio" name="fb_rating" id="star2" value="2">
                <label for="star2" title="2 stelle">‚òÖ</label>
                <input type="radio" name="fb_rating" id="star1" value="1">
                <label for="star1" title="1 stella">‚òÖ</label>
            </div>

            <textarea id="fb_comment" class="feedback-textarea"
                placeholder="Ti aspettavi un altro risultato? Hai consigli su come migliorare il sito? (facoltativo)"></textarea>

            <button onclick="submitFeedback()" id="btn-feedback" class="btn-feedback">Invia Feedback ‚ú®</button>
            <div id="fb-message" class="feedback-success"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal(event, true)">√ó</button>
            <h2 id="modal-title" style="margin-top:0; font-size:1.8rem;">Titolo Facolt√†</h2>

            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-val" id="stat-duration">3 + 2</span>
                    <span class="stat-label">Durata</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="stat-employment">90%</span>
                    <span class="stat-label">Occupazione (3 anni)</span>
                </div>
                <div class="stat-box" style="grid-column: 1 / -1;">
                    <span class="stat-val" id="stat-salary">1.500 ‚Ç¨</span>
                    <span class="stat-label">Stipendio Netto (3 anni)</span>
                </div>
            </div>

            <div style="text-align:left; margin-top:20px;">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">Corsi di Laurea Inclusi:</h4>
                <ul id="modal-courses"
                    style="padding-left:20px; color:var(--text); font-size:0.95rem; line-height:1.6;">
                    <li>Esempio Corso 1</li>
                    <li>Esempio Corso 2</li>
                </ul>
            </div>

            <div class="source-note">Dati Almalaurea 2024 (Stime medie nazionali)</div>
        </div>
    </div>

    <script>
        // --- DATI DI CONFIGURAZIONE ---
        const UNI_MAPPING = {
            "Ingegneria": ["Politecnico (Leonardo)", "Politecnico (Bovisa)", "UniBg", "UniPv", "LIUC", "Insubria"],
            "Matematica, Fisica & Informatica": ["Statale (Citt√† Studi)", "Bicocca", "Insubria", "UniPv", "Statale (Informatica)"],
            "Chimica, Biologia & Farmacia": ["Statale (Citt√† Studi)", "Bicocca", "Insubria", "UniPv", "Statale (Lodi)"],
            "Economia & Finanza": ["Bocconi", "Cattolica", "Bicocca", "Statale", "LIUC", "UniBg", "UniPv"],
            "Medicina & Sanit√†": ["Statale", "San Raffaele", "Humanitas", "Bicocca", "Insubria", "UniPv"],
            "Psicologia & Sociale": ["Bicocca", "Cattolica", "UniPv", "UniBg", "San Raffaele"],
            "Giurisprudenza": ["Statale", "Cattolica", "Bocconi", "Bicocca", "Insubria", "UniPv"],
            "Design & Architettura": ["Politecnico (Leonardo)", "Politecnico (Bovisa)", "NABA", "IED", "Accademia di Brera", "Marangoni"],
            "Studi Umanistici": ["Statale", "Cattolica", "IULM", "UniPv", "UniBg"],
            "Scienze Politiche & Sociali": ["Statale", "Cattolica", "Bocconi", "Bicocca", "UniPv"],
            "Lingue & Comunicazione": ["IULM", "Cattolica", "Statale", "UniBg", "Civica Altiero Spinelli", "Bicocca"],
            "Agraria & Veterinaria": ["Statale (Citt√† Studi)", "Statale (Lodi)"],
            "Scienze Motorie": ["Statale", "Cattolica", "Insubria", "UniPv"],
            "Moda": ["Politecnico (Bovisa)", "Marangoni", "IED", "NABA", "Domus Academy", "Secoli", "Cattolica (Fashion Mng)"],
        };

        const COMMON_SUBJECTS = [
            { label: "Italiano", id: "italiano", cat: "I" }, { label: "Storia", id: "storia", cat: "L" },
            { label: "Inglese", id: "inglese", cat: "E" }, { label: "Matematica", id: "matematica", cat: "M" },
            { label: "Scienze Motorie", id: "motorie", cat: "A" }
        ];

        const SCHOOL_DATA = {
            "Liceo Scientifico": [
                { label: "Fisica", id: "fisica", cat: "M" }, { label: "Scienze Naturali", id: "scienze", cat: "S" },
                { label: "Latino", id: "latino", cat: "I" }, { label: "Filosofia", id: "filosofia", cat: "L" },
                { label: "Disegno e Storia dell'Arte", id: "arte", cat: "A" }
            ],
            "Liceo Classico": [
                { label: "Latino", id: "latino", cat: "I" }, { label: "Greco", id: "greco", cat: "I" },
                { label: "Filosofia", id: "filosofia", cat: "L" }, { label: "Storia dell'Arte", id: "arte", cat: "L" },
                { label: "Fisica", id: "fisica", cat: "M" }, { label: "Scienze Naturali", id: "scienze", cat: "S" }
            ],
            "Liceo Linguistico": [
                { label: "Seconda Lingua", id: "lingua2", cat: "E" }, { label: "Terza Lingua", id: "lingua3", cat: "E" },
                { label: "Fisica", id: "fisica", cat: "M" }, { label: "Scienze Naturali", id: "scienze", cat: "S" },
                { label: "Filosofia", id: "filosofia", cat: "L" }, { label: "Storia dell'Arte", id: "arte", cat: "A" }
            ],
            "Liceo delle Scienze Umane": [
                { label: "Scienze Umane", id: "scienze_umane", cat: "S" }, { label: "Filosofia", id: "filosofia", cat: "L" },
                { label: "Latino", id: "latino", cat: "I" }, { label: "Fisica", id: "fisica", cat: "M" }, { label: "Storia dell'Arte", id: "arte", cat: "A" }
            ],
            "Liceo Scientifico Sportivo": [
                { label: "Discipline Sportive", id: "sport", cat: "A" }, { label: "Diritto ed Economia dello Sport", id: "diritto_sport", cat: "L" },
                { label: "Fisica", id: "fisica", cat: "M" }, { label: "Scienze Naturali", id: "scienze", cat: "S" }
            ],
            "Liceo Artistico": [
                { label: "Pittoriche/Plastiche", id: "lab_artistico", cat: "A" }, { label: "Progettazione/Architettura", id: "progettazione", cat: "M" },
                { label: "Storia dell'Arte", id: "storia_arte", cat: "L" }, { label: "Filosofia", id: "filosofia", cat: "L" }, { label: "Fisica", id: "fisica", cat: "S" }
            ],
            "Istituto Tecnico (Informatica/Elettronica)": [
                { label: "Informatica", id: "informatica", cat: "S" }, { label: "Sistemi e Reti", id: "sistemi", cat: "S" },
                { label: "Telecom/Elettronica", id: "telecom", cat: "A" }, { label: "Gestione Progetto (GPOI)", id: "gpoi", cat: "M" }
            ],
            "Istituto Tecnico (Economico/Turistico)": [
                { label: "Economia Aziendale", id: "economia_az", cat: "M" }, { label: "Diritto", id: "diritto", cat: "L" },
                { label: "Economia Politica", id: "eco_pol", cat: "L" }, { label: "Seconda Lingua", id: "lingua2", cat: "E" }
            ],
            "Istituto Tecnico - Agrario": [
                { label: "Produzioni Veg./Animali", id: "produzioni", cat: "S" }, { label: "Biotecnologie Agrarie", id: "biotech", cat: "S" },
                { label: "Trasformazione dei prodotti", id: "trasformazione", cat: "S" }, { label: "Genio Rurale", id: "genio_rurale", cat: "A" },
                { label: "Economia / Estimo", id: "estimo_agr", cat: "M" }
            ],
            "Istituto Tecnico - CAT": [
                { label: "Costruzioni (PCI)", id: "progettazione", cat: "A" }, { label: "Topografia", id: "topografia", cat: "M" },
                { label: "Estimo", id: "estimo_geo", cat: "M" }, { label: "Gestione Cantiere", id: "cantiere", cat: "A" }
            ]
        };

        const LOGIC_TECH = { "Motore": "HARDWARE", "Codice": "SOFTWARE", "Budget": "BUSINESS", "Eco": "NATURE_TECH", "None": "NONE" };
        const LOGIC_BIZ = { "Finanza": "FINANZA", "Pubblicit√†": "MARKETING", "Tribunale": "AVVOCATURA", "Politica": "POLITICA", "None": "NONE" };
        const LOGIC_SCI = { "Persone": "MEDICINA", "Animali": "VETERINARIA", "Atleti": "SPORT", "Ricerca": "BIOTECH", "Mente": "PSICOLOGIA", "None": "NONE" };
        const LOGIC_ART = { "Edifici": "ARCHITETTURA", "Oggetti": "PRODUCT", "Moda": "FASHION", "Lingue": "LANGUAGES", "Scrivere": "UMANISTICA", "None": "NONE" };
        const LOGIC_BROKEN = { "Apro": "TECNICA", "Vendo": "MERCATO", "Pulisco": "ESTETICA", "Butto": "PRAGMATISMO", "Storia": "NARRAZIONE" };

        const SUBJECT_WEIGHTS = {
            "Ingegneria": { "MATH": 0.70, "SCI": 0.20, "ENG": 0.10 },
            "Matematica, Fisica & Informatica": { "MATH": 0.80, "SCI": 0.10, "ENG": 0.10 },
            "Chimica, Biologia & Farmacia": { "SCI": 0.70, "MATH": 0.20, "ENG": 0.10 },
            "Medicina & Sanit√†": { "SCI": 0.60, "MATH": 0.20, "LIT": 0.10, "ENG": 0.10 },
            "Agraria & Veterinaria": { "SCI": 0.60, "ART": 0.20, "MATH": 0.20 },
            "Scienze Motorie": { "SCI": 0.50, "ART": 0.10, "LIT": 0.10, "MATH": 0.10, "ENG": 0.10, "ITA": 0.10 },
            "Studi Umanistici": { "LIT": 0.50, "ITA": 0.40, "ART": 0.10 },
            "Giurisprudenza": { "ITA": 0.40, "LIT": 0.40, "ENG": 0.10, "MATH": 0.10 },
            "Psicologia & Sociale": { "LIT": 0.40, "SCI": 0.30, "ITA": 0.30 },
            "Scienze Politiche & Sociali": { "LIT": 0.40, "ITA": 0.35, "ENG": 0.25 },
            "Lingue & Comunicazione": { "ENG": 0.60, "ITA": 0.30, "LIT": 0.05, "ART": 0.05 },
            "Economia & Finanza": { "MATH": 0.50, "ENG": 0.30, "LIT": 0.20 },
            "Design & Architettura": { "ART": 0.60, "MATH": 0.20, "LIT": 0.20 },
            "Moda": { "ART": 0.50, "ENG": 0.20, "MATH": 0.15, "LIT": 0.15 }
        };

        const IDEAL_PROFILES = {
            "Ingegneria": [8, 5, 4, 4], "Matematica, Fisica & Informatica": [8, 4, 2, 9],
            "Economia & Finanza": [6, 8, 7, 5], "Medicina & Sanit√†": [9, 3, 9, 4],
            "Chimica, Biologia & Farmacia": [9, 2, 4, 4], "Studi Umanistici": [4, 2, 6, 9],
            "Giurisprudenza": [8, 2, 6, 7], "Psicologia & Sociale": [5, 4, 10, 7],
            "Design & Architettura": [7, 6, 5, 5], "Lingue & Comunicazione": [5, 6, 10, 6],
            "Scienze Politiche & Sociali": [5, 5, 8, 7], "Agraria & Veterinaria": [7, 4, 4, 3],
            "Scienze Motorie": [6, 5, 8, 2],
            "Moda": [8, 7, 8, 5]
        };

        const MILANO_DB = {
            "Politecnico (Leonardo)": { "lat": 45.478, "lon": 9.227, "type": "Pubblica", "url": "https://www.polimi.it/" },
            "Politecnico (Bovisa)": { "lat": 45.506, "lon": 9.168, "type": "Pubblica", "url": "https://www.polimi.it/" },
            "Bocconi": { "lat": 45.448, "lon": 9.190, "type": "Privata", "url": "https://www.unibocconi.it/" },
            "Cattolica": { "lat": 45.463, "lon": 9.175, "type": "Privata", "url": "https://www.unicatt.it/" },
            "LIUC": { "lat": 45.611, "lon": 8.892, "type": "Privata", "url": "https://www.liuc.it/" },
            "Bicocca": { "lat": 45.513, "lon": 9.211, "type": "Pubblica", "url": "https://www.unimib.it/" },
            "Statale": { "lat": 45.460, "lon": 9.194, "type": "Pubblica", "url": "https://www.unimi.it/" },
            "Statale (Citt√† Studi)": { "lat": 45.476, "lon": 9.224, "type": "Pubblica", "url": "https://www.unimi.it/" },
            "Statale (Lodi)": { "lat": 45.317, "lon": 9.494, "type": "Pubblica", "url": "https://www.unimi.it/it/corsi/facolta-e-scuole/medicina-veterinaria" },
            "Statale (Informatica)": { "lat": 45.476, "lon": 9.224, "type": "Pubblica", "url": "https://www.unimi.it/" },
            "IULM": { "lat": 45.444, "lon": 9.162, "type": "Privata", "url": "https://www.iulm.it/" },
            "NABA": { "lat": 45.446, "lon": 9.169, "type": "Privata", "url": "https://www.naba.it/" },
            "IED": { "lat": 45.460, "lon": 9.200, "type": "Privata", "url": "https://www.ied.it/" },
            "Accademia di Brera": { "lat": 45.472, "lon": 9.188, "type": "Pubblica", "url": "https://www.accademiadibrera.milano.it/" },
            "Marangoni": { "lat": 45.465, "lon": 9.195, "type": "Privata", "url": "https://www.istitutomarangoni.com/" },
            "San Raffaele": { "lat": 45.505, "lon": 9.263, "type": "Privata", "url": "https://www.unisr.it/" },
            "Humanitas": { "lat": 45.393, "lon": 9.148, "type": "Privata", "url": "https://www.hunimed.eu/" },
            "UniBg": { "lat": 45.655, "lon": 9.633, "type": "Pubblica", "url": "https://www.unibg.it/" },
            "UniPv": { "lat": 45.186, "lon": 9.156, "type": "Pubblica", "url": "https://web.unipv.it/" },
            "Insubria": { "lat": 45.816, "lon": 8.834, "type": "Pubblica", "url": "https://www.uninsubria.it/" },
            "Domus Academy": { "lat": 45.445, "lon": 9.167, "type": "Privata", "url": "https://www.domusacademy.com/" },
            "Secoli": { "lat": 45.495, "lon": 9.213, "type": "Privata", "url": "https://www.secoli.com/" },
            "Cattolica (Fashion Mng)": { "lat": 45.463, "lon": 9.175, "type": "Privata", "url": "https://www.unicatt.it/" },
            "Civica Altiero Spinelli": { "lat": 45.463, "lon": 9.175, "type": "Pubblica", "url": "https://fondazionemilano.eu/scuole/civica-altiero-spinelli" },
            "Conservatorio G. Verdi": { "lat": 45.466, "lon": 9.205, "type": "Pubblica", "url": "https://www.consmi.it/" },
            "Civica Paolo Grassi (Teatro)": { "lat": 45.478, "lon": 9.176, "type": "Pubblica", "url": "https://paolograssi.fondazionemilano.eu/" },
            "Civica Luchino Visconti (Cinema)": { "lat": 45.508, "lon": 9.202, "type": "Pubblica", "url": "https://cinema.fondazionemilano.eu/" }
        };

        // --- DATI ALMALAUREA 2024 (STIME) ---
        const FACULTY_DETAILS = {
            "Ingegneria": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "96,5%",
                salary: "1.950 ‚Ç¨",
                courses: [
                    "Ingegneria Aerospaziale", "Ingegneria Biomedica", "Ingegneria Chimica",
                    "Ingegneria Civile", "Ingegneria dei Materiali e delle Nanotecnologie",
                    "Ingegneria dell'Automazione", "Ingegneria della Produzione Industriale",
                    "Ingegneria Edile e delle Costruzioni", "Ingegneria Elettrica", "Ingegneria Elettronica",
                    "Ingegneria Energetica", "Ingegneria Fisica", "Ingegneria Gestionale",
                    "Ingegneria Informatica", "Ingegneria Matematica", "Ingegneria Meccanica",
                    "Ingegneria per l'Ambiente e il Territorio"
                ]
            },
            "Matematica, Fisica & Informatica": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "94,2%",
                salary: "1.850 ‚Ç¨",
                courses: ["Matematica", "Fisica", "Informatica", "Data Science",
                    "Astronomia", "Cybersecurity", "Intelligenza Artificiale"]
            },
            "Economia & Finanza": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "93,8%",
                salary: "1.780 ‚Ç¨",
                courses: ["Economia Aziendale", "Finanza", "Marketing", "Management",
                    "Economia e Commercio", "Scienze Bancarie e Assicurative", "Economia del Turismo"]
            },
            "Medicina & Sanit√†": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "6 Anni (Ciclo Unico)",
                employment: "95,0%",
                salary: "1.910 ‚Ç¨ (Spec.)",
                courses: ["Medicina e Chirurgia", "Odontoiatria", "Infermieristica", "Fisioterapia", "Ostetricia",
                    "Logopedia", "Dietistica", "Tecniche di Radiologia", "Igiene Dentale", "Ortottica", "Podologia"]
            },
            "Chimica, Biologia & Farmacia": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 o 5 Anni",
                employment: "89,5%",
                salary: "1.650 ‚Ç¨",
                courses: ["Biologia", "Biotecnologie", "Chimica", "Farmacia", "CTF", "Scienze Naturali"]
            },
            "Giurisprudenza": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "5 Anni (Ciclo Unico)",
                employment: "82,5%",
                salary: "1.580 ‚Ç¨",
                courses: ["Giurisprudenza", "Diritto d'Impresa", "Scienze dei servizi giuridici", "Consulente del Lavoro"]
            },
            "Design & Architettura": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 o 5 Anni",
                employment: "88,0%",
                salary: "1.620 ‚Ç¨",
                courses: ["Architettura", "Design del Prodotto", "Interior Design", "Visual Design",
                    "Urbanistica", "Restauro"]
            },
            "Studi Umanistici": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "79,5%",
                salary: "1.450 ‚Ç¨",
                courses: ["Lettere Moderne", "Lettere Antiche", "Filosofia", "Storia", "Beni Culturali",
                    "Archeologia", "Storia dell'Arte", "Antropologia", "Geografia"]
            },
            "Lingue & Comunicazione": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "84,0%",
                salary: "1.480 ‚Ç¨",
                courses: ["Lingue e Letterature Straniere", "Scienze della Comunicazione", "Mediazione Linguistica", "DAMS"]
            },
            "Psicologia & Sociale": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "86,5%",
                salary: "1.420 ‚Ç¨",
                courses: ["Psicologia", "Scienze dell'Educazione", "Servizio Sociale", "Sociologia",
                    "Scienze della Formazione Primaria", "Pedagogia", "Scienze e Tecniche Psicologiche"]
            },
            "Scienze Politiche & Sociali": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "85,0%",
                salary: "1.550 ‚Ç¨",
                courses: ["Scienze Politiche", "Relazioni Internazionali", "Scienze dell'Amministrazione"]
            },
            "Agraria & Veterinaria": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "5 Anni / 3+2",
                employment: "89,0%",
                salary: "1.600 ‚Ç¨",
                courses: ["Medicina Veterinaria", "Scienze Agrarie", "Produzioni Animali", "Viticoltura ed Enologia"]
            },
            "Scienze Motorie": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 + 2 Anni",
                employment: "83,0%",
                salary: "1.400 ‚Ç¨",
                courses: ["Scienze Motorie", "Management dello Sport", "Attivit√† Motoria Preventiva"]
            },
            "Moda": {
                color: "linear-gradient(135deg, #e0f2fe 0%, #eff6ff 100%)",
                border: "#3b82f6",
                duration: "3 Anni<br>(+ Master)",
                employment: "87,5%",
                salary: "1.520 ‚Ç¨",
                courses: ["Fashion Design", "Fashion Business", "Fashion Styling", "Modellistica", "Design del Gioiello e Accessori"]
            }
        };

        const FUORI_MILANO_KEYS = ["UniBg", "UniPv", "LIUC", "Insubria", "Lodi"];

        // --- FUNZIONI DI INTERFACCIA ---
        function init() {
            try {
                const s = document.getElementById('school-select');
                const dropdownOptions = document.getElementById('dropdown-options');

                Object.keys(SCHOOL_DATA).forEach((k, index) => {
                    // Popola select nascosto
                    let o = document.createElement('option'); o.value = k; o.innerText = k; s.appendChild(o);

                    // Popola custom dropdown
                    const opt = document.createElement('div');
                    opt.className = 'dropdown-option' + (index === 0 ? ' selected' : '');
                    opt.innerText = k;
                    opt.onclick = () => selectSchool(k);
                    dropdownOptions.appendChild(opt);
                });

                // Chiudi dropdown quando si clicca fuori
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-dropdown')) {
                        closeDropdown();
                    }
                });

                renderSubjects(); renderRadios(); renderChecks();
                updateMap();
            } catch (e) {
                alert("Errore di inizializzazione: " + e.message);
                console.error(e);
            }
        }

        function toggleDropdown() {
            const selected = document.querySelector('.dropdown-selected');
            const options = document.getElementById('dropdown-options');
            selected.classList.toggle('open');
            options.classList.toggle('show');
        }

        function closeDropdown() {
            const selected = document.querySelector('.dropdown-selected');
            const options = document.getElementById('dropdown-options');
            selected.classList.remove('open');
            options.classList.remove('show');
        }

        function selectSchool(school) {
            // Aggiorna testo selezionato
            document.getElementById('selected-school').innerText = school;

            // Aggiorna select nascosto
            document.getElementById('school-select').value = school;

            // Aggiorna stili opzioni
            document.querySelectorAll('.dropdown-option').forEach(opt => {
                opt.classList.toggle('selected', opt.innerText === school);
            });

            // Chiudi dropdown e aggiorna materie
            closeDropdown();
            renderSubjects();
        }

        function renderSubjects() {
            const sc = document.getElementById('school-select').value;
            const cont = document.getElementById('subjects-container'); cont.innerHTML = "";
            [...COMMON_SUBJECTS, ...SCHOOL_DATA[sc]].forEach(sub => {
                cont.innerHTML += `
        <div class="card">
            <label style="font-weight: bold; font-size: 1.15em;">${sub.label}</label>
            <div class="slider-wrapper">
                <span class="slider-value" id="sv_${sub.id}">6</span>
                <input type="range" min="1" max="10" value="6" oninput="updateSliderValue(this, 'sv_${sub.id}')" data-id="${sub.id}" data-type="vote" data-cat="${sub.cat}">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>
            <div style="font-size:0.75em; text-align:center; color:#94a3b8; margin-top:-18px; margin-bottom:6px;" class="slider-helper-text">Voto (Media)</div>
            <div class="slider-wrapper" style="margin-top:15px;">
                <span class="slider-value" id="se_${sub.id}">5</span>
                <input type="range" min="1" max="10" value="5" oninput="updateSliderValue(this, 'se_${sub.id}')" data-id="${sub.id}" data-type="effort">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>
            <div style="font-size:0.75em; text-align:center; color:#94a3b8; margin-top:-18px;" class="slider-helper-text">Fatica (1=Poca, 10=Tanta)</div>
            <hr style="border:0; border-top:1px solid #eee; margin-top:15px;">
        </div>`;
            });
            // Initialize slider positions
            document.querySelectorAll('.slider-wrapper input[type="range"]').forEach(initSliderValue);
        }

        function renderRadios() {
            const mkRadio = (id, opts, dest) => {
                opts.forEach(o => document.getElementById(dest).innerHTML += `<label class="radio-option"><input type="radio" name="${id}" value="${o.v}" ${['None', 'Apro', 'Azienda', 'ROCKET', 'HACKER', 'CEO'].includes(o.v) ? 'checked' : ''}> ${o.t}</label>`);
            };

            mkRadio("q_tech", [
                { v: "Motore", t: "Voglio capire come funziona il motore e aggiustarlo." },
                { v: "Codice", t: "Voglio scrivere il codice che guida il razzo da remoto." },
                { v: "Budget", t: "Voglio gestire il budget e organizzare la missione." },
                { v: "Eco", t: "Voglio che la missione sia al 100% ecosostenibile." },
                { v: "None", t: "Nessuno di questi: Mi licenzio." }
            ], "q_tech_c");

            mkRadio("q_biz", [
                { v: "Finanza", t: "Analizzo i mercati e faccio soldi con i soldi." },
                { v: "Pubblicit√†", t: "Creo la pubblicit√† che ti convince a comprare qualsiasi cosa." },
                { v: "Tribunale", t: "Difendo i miei clienti in tribunale fino all'ultimo." },
                { v: "Politica", t: "Cerco di trovare accordi tra nazioni in conflitto." },
                { v: "None", t: "Nessuno di questi: Prendo l'ascensore e scappo dall'ufficio." }
            ], "q_biz_c");

            mkRadio("q_sci", [
                { v: "Persone", t: "Voglio curare le persone e salvare vite." },
                { v: "Animali", t: "Preferisco curare animali o studiare le piante." },
                { v: "Atleti", t: "Voglio migliorare le performance degli atleti e farli vincere." },
                { v: "Ricerca", t: "Voglio stare in laboratorio a scoprire cure o studiare virus." },
                { v: "Mente", t: "Voglio entrare nella testa delle persone e capire come ragionano." },
                { v: "None", t: "Nessuno di questi: La scienza non fa per me." }
            ], "q_sci_c");

            mkRadio("q_art", [
                { v: "Edifici", t: "Voglio progettare grattacieli e case da sogno." },
                { v: "Oggetti", t: "Voglio disegnare oggetti, app o vestiti che tutti useranno." },
                { v: "Moda", t: "Vivo per la moda, i trend e lo stile." },
                { v: "Lingue", t: "Voglio viaggiare e parlare fluentemente 3 o 4 lingue." },
                { v: "Scrivere", t: "Voglio raccontare storie e scrivere articoli." },
                { v: "None", t: "Nessuno di questi: La creativit√† non √® il mio forte." }
            ], "q_art_c");

            mkRadio("q_youtube", [
                { v: "ROCKET", t: "Come funziona davvero un reattore nucleare e perch√© non esplode?" },
                { v: "MONEY", t: "Come fanno le app gratis a guadagnare miliardi?" },
                { v: "BODY", t: "Cosa succede esattamente quando smetti di dormire?" },
                { v: "LAW", t: "L'errore nel contratto che ha fregato l'azienda." },
                { v: "ARCHI", t: "Perch√© i grattacieli di Dubai non crollano?" },
                { v: "None", t: "Nessuno di questi: Chiudo YouTube e vado a dormire." }
            ], "q_youtube_c");

            mkRadio("q_netflix", [
                { v: "HACKER", t: "L'Hacker che entra nel sistema della banca in 10 secondi." },
                { v: "PROFILER", t: "Il Profiler che capisce chi √® il colpevole solo guardandolo negli occhi." },
                { v: "SURGEON", t: "Il Chirurgo che mantiene il sangue freddo quando tutto va male." },
                { v: "LAWYER", t: "L'Avvocato in giacca e cravatta che convince la giuria con un discorso epico." },
                { v: "EXPLORER", t: "L'Esploratore che viaggia in posti sperduti e parla con la gente locale." },
                { v: "None", t: "Nessuno di questi: Al massimo la comparsa." }
            ], "q_netflix_c");

            mkRadio("q_startup", [
                { v: "CEO", t: "Decido la strategia, parlo con gli investitori e gestisco i soldi." },
                { v: "CTO", t: "Costruisco il prodotto, scrivo il codice e risolvo i bug." },
                { v: "CREATIVE", t: "Creo il logo, il design e la campagna virale su TikTok." },
                { v: "HR", t: "Gestisco le persone e mi assicuro che tutti siano felici." },
                { v: "VISION", t: "Scrivo i Contratti per proteggere l'azienda." },
                { v: "None", t: "Nessuno di questi: Vendo le mie quote e vado in vacanza." }
            ], "q_startup_c");

            mkRadio("q_broken", [
                { v: "Apro", t: "Lo apro per vedere com'√® fatto" },
                { v: "Vendo", t: "Cerco quanto vale per venderlo" },
                { v: "Pulisco", t: "Lo pulisco e lo uso per arredamento" },
                { v: "Butto", t: "Lo butto, √® spazzatura" },
                { v: "Storia", t: "Immagino la sua storia" }
            ], "q_broken_c");

            mkRadio("q_future", [
                { v: "Azienda", t: "In una grande Azienda o Tech Company (Ufficio/Grattacielo)" },
                { v: "Camice", t: "In camice bianco (Laboratorio di Ricerca o Ospedale)" },
                { v: "Creativo", t: "In uno spazio Creativo (Atelier, Redazione, Studio di Design)" },
                { v: "Istituzioni", t: "In contesti Istituzionali (Tribunale, Politica, Diplomazia)" },
                { v: "Persone", t: "A contatto diretto con le persone (Scuola, Psicologia, Sociale)" },
                { v: "Movimento", t: "In movimento o nella Natura (Sport, Cantieri, Campi, Viaggi)" }
            ], "q_future_c");
        }

        function renderChecks() {
            const opts = [
                { id: "chk_teach", t: "I compagni ti chiedono spesso aiuto per capire le lezioni" },
                { id: "chk_nature", t: "Ti rilassa stare nella natura e ti preoccupi per l'ambiente" },
                { id: "chk_money", t: "Ti incuriosisce capire come girano i soldi nel mondo" },
                { id: "chk_care", t: "Ti senti realizzato quando aiuti o ascolti chi sta male" },
                { id: "chk_sport", t: "Lo sport √® una parte fondamentale della tua vita" },
                { id: "chk_write", t: "Ami scrivere o imparare nuove lingue" },
                { id: "chk_law", t: "Non sopporti le ingiustizie e difendi sempre le tue idee" },
                { id: "chk_tech", t: "A casa sei quello che risolve i problemi con il PC o le cose elettroniche" },
                { id: "chk_politics", t: "Segui con interesse la politica e l'attualit√†" },
                { id: "chk_art", t: "Hai un forte senso estetico e noti anche i piccoli dettagli" }
            ];
            opts.forEach(o => document.getElementById("chk_container").innerHTML += `<label class="radio-option"><input type="checkbox" id="${o.id}"> ${o.t}</label>`);
        }

        function nextStep(n) {
            window.scrollTo(0, 0); // Scroll to top
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${n}`).classList.add('active');

            // Calcolo barra progresso: step 1 = 0%, step 2-5 = progressivo, step 6 = 100%
            let progressPercent;
            if (n === 1) {
                progressPercent = 0;
            } else if (n === 6) {
                progressPercent = 100;
            } else {
                progressPercent = ((n - 1) / 5) * 100;
            }
            document.getElementById('progress').style.width = progressPercent + "%";

            // Aggiorna indicatore testuale
            const indicator = document.getElementById('step-indicator');
            if (n === 6) {
                indicator.innerText = "I tuoi risultati";
            } else {
                indicator.innerText = `Step ${n} di 5`;
            }

            window.scrollTo(0, 0);
        }

        function getVal(id) { return parseInt(document.getElementById(id).value); }
        function getRadio(n) { return document.querySelector(`input[name="${n}"]:checked`).value; }
        function getChk(id) { return document.getElementById(id).checked; }

        // Funzioni per slider con valore sopra thumb
        function updateSliderValue(slider, valueId) {
            const valueSpan = document.getElementById(valueId);
            valueSpan.textContent = slider.value;
            positionSliderValue(slider, valueSpan);
        }

        function positionSliderValue(slider, valueSpan) {
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const val = parseFloat(slider.value);
            const percent = ((val - min) / (max - min)) * 100;
            valueSpan.style.left = `calc(${percent}% + (${8 - percent * 0.16}px))`;
            // Fill track left side with primary color (WebKit fix)
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const trackColor = isDark ? 'rgba(71, 85, 105, 0.6)' : 'rgba(226, 232, 240, 0.8)';
            const primaryColor = isDark ? '#818cf8' : '#6366f1';
            slider.style.background = `linear-gradient(to right, ${primaryColor} 0%, ${primaryColor} ${percent}%, ${trackColor} ${percent}%, ${trackColor} 100%)`;
            slider.style.borderRadius = '3px';
            slider.style.height = '6px';
        }

        function initSliderValue(slider) {
            const wrapper = slider.closest('.slider-wrapper');
            if (!wrapper) return;
            const valueSpan = wrapper.querySelector('.slider-value');
            if (valueSpan) {
                positionSliderValue(slider, valueSpan);
            }
        }

        // =============================================================================
        // MOTORE DI CALCOLO (VERSIONE PYTHON FEDELE)
        // =============================================================================
        function calculateAndShow() {
            try {
                // 1. INPUT RECOVERY
                const school = document.getElementById('school-select').value;
                const gradesInput = document.querySelectorAll('#subjects-container input[type="range"]');

                // --- SEZIONE 0: BONUS SCUOLA (FEDELE AL PYTHON) ---
                let sec0 = {}; Object.keys(UNI_MAPPING).forEach(k => sec0[k] = 0);
                const add0 = (list, pts) => list.forEach(f => sec0[f] += pts);
                const sub0 = (list, pts) => list.forEach(f => sec0[f] -= pts);

                if (school === "Liceo Scientifico") {
                    add0(["Ingegneria", "Matematica, Fisica & Informatica", "Medicina & Sanit√†", "Chimica, Biologia & Farmacia"], 15);
                    add0(["Economia & Finanza", "Design & Architettura"], 10);
                    sub0(["Scienze Motorie"], 15);
                } else if (school === "Liceo Classico") {
                    add0(["Studi Umanistici", "Giurisprudenza", "Scienze Politiche & Sociali", "Psicologia & Sociale"], 20);
                    add0(["Medicina & Sanit√†"], 10);
                    sub0(["Ingegneria", "Matematica, Fisica & Informatica", "Scienze Motorie"], 10);
                } else if (school === "Liceo Linguistico") {
                    add0(["Lingue & Comunicazione", "Scienze Politiche & Sociali"], 20);
                    sub0(["Ingegneria", "Matematica, Fisica & Informatica", "Medicina & Sanit√†"], 10);
                } else if (school === "Liceo Scientifico Sportivo") {
                    add0(["Scienze Motorie"], 30);
                    add0(["Medicina & Sanit√†", "Chimica, Biologia & Farmacia"], 15);
                    add0(["Ingegneria"], 10);
                } else if (school === "Liceo delle Scienze Umane") {
                    add0(["Psicologia & Sociale", "Studi Umanistici"], 25);
                    add0(["Scienze Motorie"], 10);
                    sub0(["Ingegneria", "Matematica, Fisica & Informatica", "Economia & Finanza"], 5);
                } else if (school === "Liceo Artistico") {
                    add0(["Design & Architettura"], 30);
                    add0(["Studi Umanistici"], 10);
                    sub0(["Ingegneria", "Economia & Finanza", "Giurisprudenza"], 15);
                } else if (school.includes("Informatica")) {
                    add0(["Ingegneria", "Matematica, Fisica & Informatica"], 25);
                    sub0(["Studi Umanistici", "Giurisprudenza", "Psicologia & Sociale"], 15);
                } else if (school.includes("Economico")) {
                    add0(["Economia & Finanza"], 25);
                    add0(["Lingue & Comunicazione", "Giurisprudenza"], 10);
                    sub0(["Medicina & Sanit√†", "Ingegneria", "Chimica, Biologia & Farmacia"], 15);
                } else if (school.includes("Agrario") || school.includes("CAT")) {
                    // La logica Python raggruppava "Agrario/Geometra", qui applichiamo a entrambi
                    add0(["Agraria & Veterinaria", "Design & Architettura"], 25);
                    sub0(["Studi Umanistici", "Lingue & Comunicazione", "Psicologia & Sociale"], 15);
                }

                // --- SEZIONE 1: VOTI (AGGREGATORE DINAMICO) ---
                let macro = { M: [], S: [], L: [], I: [], E: [], A: [] };
                // Raccogli voti dagli input
                let tempGrades = {};
                gradesInput.forEach(i => {
                    if (!tempGrades[i.dataset.id]) tempGrades[i.dataset.id] = { cat: i.dataset.cat };
                    if (i.dataset.type === 'vote') tempGrades[i.dataset.id].v = parseInt(i.value) || 6;
                    if (i.dataset.type === 'effort') tempGrades[i.dataset.id].e = parseInt(i.value) || 5;
                });

                Object.values(tempGrades).forEach(g => {
                    let raw = (g.v * 7) + ((10 - g.e) * 3);
                    macro[g.cat].push(Math.min(100, raw));
                });

                let subj_scores = {};
                const mapK = { M: "MATH", S: "SCI", L: "LIT", I: "ITA", E: "ENG", A: "ART" };
                Object.keys(macro).forEach(k => {
                    let arr = macro[k];
                    subj_scores[mapK[k]] = arr.length ? arr.reduce((a, b) => a + b) / arr.length : 50.0;
                });

                let sec1 = {};
                Object.keys(SUBJECT_WEIGHTS).forEach(fac => {
                    let w = SUBJECT_WEIGHTS[fac];
                    let s = 0;
                    Object.keys(w).forEach(sub => s += (subj_scores[sub] || 0) * w[sub]);
                    sec1[fac] = s;
                });

                // --- SEZIONE 2: INTERESSI ---
                let sec2 = {}; Object.keys(UNI_MAPPING).forEach(k => sec2[k] = 0);
                const add2 = (list, pts) => list.forEach(f => sec2[f] = Math.min(100, sec2[f] + pts));
                const sub2 = (list, pts) => list.forEach(f => sec2[f] -= pts);

                const tv = LOGIC_TECH[getRadio("q_tech")];
                if (tv === "HARDWARE") { add2(["Ingegneria"], 60); add2(["Design & Architettura"], 30); }
                else if (tv === "SOFTWARE") { add2(["Matematica, Fisica & Informatica"], 60); add2(["Ingegneria"], 40); }
                else if (tv === "BUSINESS") { add2(["Economia & Finanza"], 60); add2(["Ingegneria"], 20); }
                else if (tv === "NATURE_TECH") { add2(["Agraria & Veterinaria"], 60); add2(["Chimica, Biologia & Farmacia"], 40); }
                else { sub2(["Ingegneria", "Matematica, Fisica & Informatica"], 30); sub2(["Agraria & Veterinaria"], 15); }

                const bv = LOGIC_BIZ[getRadio("q_biz")];
                if (bv === "FINANZA") add2(["Economia & Finanza"], 60);
                else if (bv === "MARKETING") { add2(["Lingue & Comunicazione"], 60); add2(["Economia & Finanza"], 40); add2(["Psicologia & Sociale"], 30); add2(["Moda"], 20); }
                else if (bv === "AVVOCATURA") add2(["Giurisprudenza"], 60);
                else if (bv === "POLITICA") { add2(["Scienze Politiche & Sociali"], 60); add2(["Giurisprudenza"], 30); add2(["Lingue & Comunicazione"], 20); }
                else sub2(["Economia & Finanza", "Giurisprudenza"], 30);

                const sv = LOGIC_SCI[getRadio("q_sci")];
                if (sv === "MEDICINA") add2(["Medicina & Sanit√†"], 60);
                else if (sv === "VETERINARIA") { add2(["Agraria & Veterinaria"], 60); add2(["Chimica, Biologia & Farmacia"], 20); }
                else if (sv === "SPORT") { add2(["Scienze Motorie"], 60); add2(["Medicina & Sanit√†"], 20); }
                else if (sv === "BIOTECH") { add2(["Chimica, Biologia & Farmacia"], 60); add2(["Medicina & Sanit√†"], 20); }
                else if (sv === "PSICOLOGIA") { add2(["Psicologia & Sociale"], 60); add2(["Studi Umanistici"], 20); }
                else sub2(["Medicina & Sanit√†", "Chimica, Biologia & Farmacia"], 30);

                const av = LOGIC_ART[getRadio("q_art")];
                if (av === "ARCHITETTURA") { add2(["Design & Architettura"], 60); add2(["Ingegneria"], 30); }
                else if (av === "PRODUCT") { add2(["Design & Architettura"], 50); add2(["Ingegneria"], 20) }
                else if (av === "FASHION") { add2(["Moda"], 70); add2(["Design & Architettura"], 30); }
                else if (av === "LANGUAGES") { add2(["Lingue & Comunicazione"], 60); add2(["Scienze Politiche & Sociali"], 30); }
                else if (av === "UMANISTICA") { add2(["Studi Umanistici"], 60); add2(["Scienze Politiche & Sociali"], 20); }
                else sub2(["Design & Architettura", "Studi Umanistici"], 30);

                // --- NUOVA LOGICA DOMANDE INDIRETTE (CUMULATIVA E BILANCIATA) ---

                // 1. YOUTUBE
                const yv = getRadio("q_youtube");
                if (yv === "ROCKET") { add2(["Ingegneria"], 30); add2(["Matematica, Fisica & Informatica"], 15); }
                else if (yv === "MONEY") { add2(["Economia & Finanza"], 30); }
                else if (yv === "BODY") { add2(["Medicina & Sanit√†"], 30); add2(["Chimica, Biologia & Farmacia"], 25); add2(["Scienze Motorie"], 25); add2(["Agraria & Veterinaria"], 10); }
                else if (yv === "LAW") { add2(["Giurisprudenza"], 30); add2(["Scienze Politiche & Sociali"], 15); }
                else if (yv === "ARCHI") { add2(["Design & Architettura"], 30); add2(["Ingegneria"], 10); add2(["Moda"], 10); }
                else if (yv === "None") {
                    sub2(["Ingegneria", "Economia & Finanza", "Medicina & Sanit√†", "Chimica, Biologia & Farmacia", "Scienze Motorie", "Giurisprudenza", "Design & Architettura"], 10);
                }

                // 2. NETFLIX
                const nv = getRadio("q_netflix");
                if (nv === "HACKER") { add2(["Matematica, Fisica & Informatica"], 30); add2(["Ingegneria"], 15); }
                else if (nv === "PROFILER") { add2(["Psicologia & Sociale"], 30); add2(["Studi Umanistici"], 20); }
                else if (nv === "SURGEON") { add2(["Medicina & Sanit√†"], 25); add2(["Scienze Motorie"], 15); add2(["Chimica, Biologia & Farmacia"], 20); }
                else if (nv === "LAWYER") { add2(["Giurisprudenza"], 30); add2(["Scienze Politiche & Sociali"], 15); }
                else if (nv === "EXPLORER") { add2(["Lingue & Comunicazione"], 30); add2(["Studi Umanistici"], 20); add2(["Scienze Politiche & Sociali"], 10); add2(["Agraria & Veterinaria"], 30); }
                else if (nv === "None") {
                    sub2(["Matematica, Fisica & Informatica", "Psicologia & Sociale", "Medicina & Sanit√†", "Giurisprudenza", "Lingue & Comunicazione", "Agraria & Veterinaria"], 10);
                }

                // 3. STARTUP
                const sv2 = getRadio("q_startup");
                if (sv2 === "CEO") { add2(["Economia & Finanza"], 30); add2(["Scienze Politiche & Sociali"], 10); }
                else if (sv2 === "CTO") { add2(["Ingegneria"], 25); add2(["Matematica, Fisica & Informatica"], 25); }
                else if (sv2 === "CREATIVE") { add2(["Design & Architettura"], 25); add2(["Moda"], 30); add2(["Lingue & Comunicazione"], 10); }
                else if (sv2 === "HR") { add2(["Psicologia & Sociale"], 30); add2(["Scienze Politiche & Sociali"], 15); }
                else if (sv2 === "VISION") { add2(["Giurisprudenza"], 30); add2(["Studi Umanistici"], 20); }
                else if (sv2 === "None") {
                    sub2(["Economia & Finanza", "Ingegneria", "Matematica, Fisica & Informatica", "Design & Architettura", "Moda", "Psicologia & Sociale", "Giurisprudenza", "Studi Umanistici"], 10);
                }

                // --- SEZIONE 3: MENTE E STILE ---
                let sec3 = {};
                const uProf = [getVal('s_detail'), getVal('s_risk'), getVal('s_people'), getVal('s_abs')];
                Object.keys(IDEAL_PROFILES).forEach(fac => {
                    let ideal = IDEAL_PROFILES[fac];
                    let tDist = 0, pen = 0;
                    for (let i = 0; i < 4; i++) {
                        let d = Math.abs(uProf[i] - ideal[i]);
                        tDist += d;
                        if (d >= 7) pen += 40; else if (d >= 5) pen += 10;
                    }
                    let base = Math.max(0, 100 - (tDist / 4) * 10);
                    sec3[fac] = base - pen;
                });

                // --- SEZIONE 4: SCENARI ---
                let sec4 = {}; Object.keys(UNI_MAPPING).forEach(k => sec4[k] = 0);
                const add4 = (list, pts) => list.forEach(f => sec4[f] += pts);
                const brV = LOGIC_BROKEN[getRadio("q_broken")];

                if (brV === "TECNICA") add4(["Ingegneria", "Matematica, Fisica & Informatica"], 50);
                else if (brV === "MERCATO") add4(["Economia & Finanza"], 50);
                else if (brV === "ESTETICA") { add4(["Moda"], 50); add4(["Design & Architettura"], 30); }
                else if (brV === "PRAGMATISMO") add4(["Economia & Finanza", "Ingegneria"], 20);
                else if (brV === "NARRAZIONE") add4(["Studi Umanistici", "Psicologia & Sociale"], 50);

                const futV = getRadio("q_future");
                if (futV === "Azienda") { add4(["Economia & Finanza", "Ingegneria"], 50); add4(["Matematica, Fisica & Informatica"], 40); add4(["Lingue & Comunicazione"], 10); }
                else if (futV === "Camice") { add4(["Medicina & Sanit√†", "Chimica, Biologia & Farmacia"], 50); add4(["Agraria & Veterinaria"], 30); add4(["Psicologia & Sociale"], 10); }
                else if (futV === "Creativo") { add4(["Moda"], 50); add4(["Design & Architettura"], 50); add4(["Studi Umanistici", "Lingue & Comunicazione"], 30); }
                else if (futV === "Istituzioni") { add4(["Giurisprudenza", "Scienze Politiche & Sociali"], 50); add4(["Economia & Finanza"], 20); }
                else if (futV === "Persone") { add4(["Psicologia & Sociale", "Studi Umanistici"], 50); add4(["Lingue & Comunicazione"], 40); add4(["Medicina & Sanit√†", "Scienze Motorie"], 30); }
                else if (futV === "Movimento") { add4(["Agraria & Veterinaria", "Scienze Motorie"], 50); add4(["Design & Architettura"], 20); add4(["Chimica, Biologia & Farmacia", "Ingegneria"], 10); }

                // --- SEZIONE 5: CONFERME ---
                let sec5 = {}; Object.keys(UNI_MAPPING).forEach(k => sec5[k] = 0);
                const add5 = (f, pts) => sec5[f] += pts;

                if (getChk("chk_teach")) { add5("Studi Umanistici", 100); add5("Matematica, Fisica & Informatica", 50); add5("Lingue & Comunicazione", 30); add5("Ingegneria", 30); }
                if (getChk("chk_nature")) { add5("Agraria & Veterinaria", 100); add5("Chimica, Biologia & Farmacia", 30); }
                if (getChk("chk_money")) { add5("Economia & Finanza", 100); add5("Ingegneria", 40); add5("Giurisprudenza", 20); }
                if (getChk("chk_care")) { add5("Medicina & Sanit√†", 100); add5("Psicologia & Sociale", 80); add5("Scienze Motorie", 20); }
                if (getChk("chk_sport")) { add5("Scienze Motorie", 100); add5("Medicina & Sanit√†", 20); }
                if (getChk("chk_write")) { add5("Lingue & Comunicazione", 100); add5("Studi Umanistici", 100); add5("Scienze Politiche & Sociali", 30); }
                if (getChk("chk_law")) { add5("Giurisprudenza", 100); add5("Scienze Politiche & Sociali", 50); }
                if (getChk("chk_tech")) { add5("Ingegneria", 100); add5("Matematica, Fisica & Informatica", 100); add5("Design & Architettura", 20); }
                if (getChk("chk_politics")) { add5("Scienze Politiche & Sociali", 100); add5("Giurisprudenza", 50); add5("Economia & Finanza", 20); }
                if (getChk("chk_art")) { add5("Moda", 100); add5("Design & Architettura", 80); add5("Studi Umanistici", 20); }

                // CAP A 100 PER SEC 5
                Object.keys(sec5).forEach(k => { if (sec5[k] > 100) sec5[k] = 100; });

                // --- CALCOLO FINALE ---
                let finalScores = {};
                Object.keys(UNI_MAPPING).forEach(fac => {
                    let raw = (sec0[fac] * 0.5) + (sec1[fac] * 0.25) + (sec2[fac] * 0.30) + (sec3[fac] * 0.25) + (sec4[fac] * 0.10) + (sec5[fac] * 0.10);
                    if (raw > 75) raw += 10;
                    finalScores[fac] = Math.min(100, raw);
                });

                // EXPOSE SCORES FOR CHATBOT
                window.scores = finalScores;

                // OUTPUT
                let sorted = Object.entries(finalScores).sort((a, b) => b[1] - a[1]);
                const winner = sorted[0];

                document.getElementById('w_name').innerText = "ü•á " + winner[0];
                document.getElementById('w_name').innerText = "ü•á " + winner[0];

                // Uniform Score Graphics for Winner - Border matches card bg
                // Background matches card (Blue #dbeafe), Text Dark Blue
                document.getElementById('w_score').innerHTML = `
                    <div style="display:inline-block; padding:8px 20px; background:#dbeafe; color:#1e3a8a; border-radius:30px; font-weight:800; box-shadow:0 4px 15px rgba(59, 130, 246, 0.2); border: 3px solid #bfdbfe;">
                        Punteggio: ${Math.round(winner[1])}
                    </div>`;

                // Style Winner Box - Colore Standard CSS (Blu)
                const wBox = document.querySelector('.winner-box');
                // Clean up any inline styles from previous logic
                wBox.style.background = '';
                wBox.style.borderColor = '';
                wBox.onclick = () => openModal(winner[0]);

                const runDiv = document.getElementById('runners'); runDiv.innerHTML = "";
                // Reset classes
                runDiv.className = 'runners-grid';
                const medals = ["ü•à", "ü•â", "4Ô∏è‚É£", "5Ô∏è‚É£"];

                // Filtra facolt√† con almeno 65% del punteggio del vincitore
                const threshold = winner[1] * 0.65;
                // Limit to Top 5
                let recommended = sorted.filter(r => r[1] >= threshold).slice(0, 5);

                // Mostra alternative (escluso il vincitore)
                recommended.slice(1).forEach((r, index) => {
                    // Rimossi stili inline per background e border -> Usa CSS .runner-card (Azzurro)
                    // Rimossi stili inline per score -> Usa CSS .runner-score (Purple Gradient Badge)
                    // Added border to score matching card bg (#eff6ff approx)
                    runDiv.innerHTML += `
                    <div class="runner-card" data-faculty="${r[0]}" style="cursor: pointer;">
                        <div class="runner-name">
                            <span style="font-size:1.2em">${medals[index]}</span> ${r[0]}
                        </div>
                        <div class="runner-score" style="border: 3px solid #eff6ff;">${Math.round(r[1])}</div>
                    </div>`;
                });

                // Attach click handlers safely via JS (better than inline HTML which can break with special chars)
                runDiv.querySelectorAll('.runner-card').forEach(card => {
                    card.addEventListener('click', () => {
                        openModal(card.dataset.faculty);
                    });
                });

                // Apply dynamic layout class based on number of runners
                const runnerCount = recommended.length - 1; // Exclude winner
                if (runnerCount > 0) {
                    runDiv.classList.add('layout-' + runnerCount);
                }

                // Safety check: se recommended √® vuoto, usa il vincitore
                if (recommended.length === 0) {
                    recommended.push(winner);
                }

                // Salva dati globalmente per toggle
                window.allSorted = sorted;
                window.recommended = recommended; // Store clamped recommended list
                window.recommendedCount = recommended.length;
                window.showingAll = false;

                // Aggiorna Chart - mostra solo facolt√† consigliate
                renderChart(recommended);

                // Aggiorna testo bottone e visibilit√†
                const btn = document.getElementById('toggle-chart-btn');
                btn.innerHTML = 'Mostra tutte le facolt√†';

                // Aggiorna Dropdown Mappa Custom - solo facolt√† consigliate
                const ms = document.getElementById('map-select'); ms.innerHTML = "";
                const dropdownOpts = document.getElementById('map-dropdown-options'); dropdownOpts.innerHTML = "";

                recommended.forEach((s, index) => {
                    // Popola select nascosto
                    let o = document.createElement('option'); o.value = s[0]; o.innerText = s[0]; ms.appendChild(o);

                    // Popola custom dropdown
                    const opt = document.createElement('div');
                    opt.className = 'dropdown-option' + (index === 0 ? ' selected' : '');
                    opt.innerText = s[0];
                    opt.onclick = () => selectFaculty(s[0]);
                    dropdownOpts.appendChild(opt);
                });

                // Imposta testo iniziale
                document.getElementById('selected-faculty').innerText = recommended[0][0];
                updateMap();

                // Mostra popup feedback dopo 5 secondi
                setTimeout(() => {
                    document.getElementById('feedback-overlay').classList.add('show');
                }, 5000);

                nextStep(6);
            } catch (e) {
                console.error("Errore calcolo:", e);
                alert("Si √® verificato un errore: " + e.message);
            }
        }

        // Funzione per renderizzare il chart
        function renderChart(data) {
            if (myChart) myChart.destroy();

            // Genera colori blu sfumati (basati sulla posizione originale in classifica generale)
            const allData = (window.allSorted && window.allSorted.length > 0) ? window.allSorted : data;
            const maxIndex = Math.max(allData.length - 1, 1);

            const blueColors = data.map((item) => {
                // Trova indice nella classifica globale per mantenere colore costante
                const originalIndex = allData.findIndex(x => x[0] === item[0]);
                const i = originalIndex >= 0 ? originalIndex : 0;

                const ratio = i / maxIndex;
                // Da blu scuro (30, 64, 175) a blu chiaro (147, 197, 253)
                const r = Math.round(30 + ratio * 117);
                const g = Math.round(64 + ratio * 133);
                const b = Math.round(175 + ratio * 78);
                return `rgba(${r}, ${g}, ${b}, 0.85)`;
            });
            const blueBorders = data.map((item) => {
                const originalIndex = allData.findIndex(x => x[0] === item[0]);
                const i = originalIndex >= 0 ? originalIndex : 0;

                const ratio = i / maxIndex;
                const r = Math.round(30 + ratio * 90);
                const g = Math.round(64 + ratio * 100);
                const b = Math.round(175 + ratio * 50);
                return `rgb(${r}, ${g}, ${b})`;
            });

            const container = document.getElementById('chart-container');
            container.style.height = (data.length * 45 + 50) + 'px';

            myChart = new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.map(x => x[0]),
                    datasets: [{
                        label: 'Affinit√†',
                        data: data.map(x => x[1]),
                        backgroundColor: blueColors,
                        borderColor: blueBorders,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(37, 99, 235, 0.1)' },
                            ticks: { color: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '#ffffff' : '#64748b', font: { size: 11 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '#ffffff' : '#334155', font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }

        // Funzione per mostrare/nascondere tutte le facolt√†
        function toggleChartView() {
            const btn = document.getElementById('toggle-chart-btn');
            const count = window.recommendedCount || 5;
            // Use the stored recommended list to ensure consistency (max 5)
            const recommended = window.recommended || [];

            if (window.showingAll) {
                renderChart(recommended);
                btn.innerHTML = 'Mostra tutte le facolt√†';
                window.showingAll = false;
            } else {
                renderChart(window.allSorted);
                btn.innerHTML = `Mostra solo Top ${count}`;
                window.showingAll = true;
            }
        }

        // Dropdown mappa funzioni
        function toggleMapDropdown() {
            const selected = document.querySelector('#map-dropdown .dropdown-selected');
            const options = document.getElementById('map-dropdown-options');
            selected.classList.toggle('open');
            options.classList.toggle('show');
        }

        function selectFaculty(faculty) {
            document.getElementById('selected-faculty').innerText = faculty;
            document.getElementById('map-select').value = faculty;

            // Aggiorna stili opzioni map dropdown
            document.querySelectorAll('#map-dropdown-options .dropdown-option').forEach(opt => {
                opt.classList.toggle('selected', opt.innerText === faculty);
            });

            // Chiudi dropdown
            document.querySelector('#map-dropdown .dropdown-selected').classList.remove('open');
            document.getElementById('map-dropdown-options').classList.remove('show');

            updateMap();
        }

        // --- MODAL FUNCTIONS ---
        function openModal(facultyName) {
            const data = FACULTY_DETAILS[facultyName];
            if (!data) return;

            document.getElementById('modal-title').innerText = facultyName;
            document.getElementById('stat-duration').innerHTML = data.duration; // Changed to innerHTML for <br>
            document.getElementById('stat-employment').innerText = data.employment;
            document.getElementById('stat-salary').innerText = data.salary;

            // Populate courses list
            const coursesList = document.getElementById('modal-courses');
            coursesList.innerHTML = "";
            if (data.courses && data.courses.length > 0) {
                data.courses.forEach(c => {
                    coursesList.innerHTML += `<li>${c}</li>`;
                });
            } else {
                coursesList.innerHTML = "<li>Dati non disponibili</li>";
            }

            // Header color matching
            document.getElementById('modal-title').style.color = data.border;
            document.querySelectorAll('.stat-val').forEach(el => el.style.color = data.border);

            const overlay = document.getElementById('modal-overlay');
            overlay.classList.add('active');
        }

        function closeModal(e, force = false) {
            if (force || e.target.classList.contains('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        }

        function renderUniList(unis) {
            const container = document.getElementById('unis-list-container');
            container.innerHTML = "";

            const m = [], f = [];
            unis.forEach(u => {
                if (FUORI_MILANO_KEYS.some(k => u.includes(k))) f.push(u);
                else m.push(u);
            });

            const genGrid = (list) => {
                let h = '<div class="uni-grid">';
                list.forEach(u => {
                    const d = MILANO_DB[u] || { type: "N/D" };
                    const cls = d.type === 'Pubblica' ? 'badge-pub' : 'badge-priv';
                    const lbl = d.type === 'Pubblica' ? 'üèõÔ∏è PUBBLICA' : 'üíé PRIVATA';
                    const url = d.url || "#";

                    // Card ridisegnata: Freccina in alto a dx, badge in basso
                    h += `
                    <div class="uni-card ${cls}">
                        <a href="${url}" target="_blank" class="uni-link-icon" title="Vai al sito">‚Üó</a>
                        <div style="margin-right: 30px; margin-bottom: 15px;">
                            <strong>${u}</strong>
                        </div>
                        <div style="margin-top: auto;">
                            <span class="badge-text">${lbl}</span>
                        </div>
                    </div>`;
                });
                h += '</div>';
                return h;
            };

            if (m.length > 0) {
                container.innerHTML += `<h4 style="margin-bottom: 15px; color: #1e293b;" class="uni-section-heading">üè´ A Milano:</h4>` + genGrid(m);
            }
            if (f.length > 0) {
                if (m.length > 0) container.innerHTML += `<hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">`;
                container.innerHTML += `<h4 style="margin-bottom: 15px; color: #1e293b;" class="uni-section-heading">üöÜ Fuori Milano:</h4>` + genGrid(f);
            }
        }

        // MAPPA
        let map, markers = [];
        function updateMap() {
            if (!map) {
                map = L.map('map').setView([45.4642, 9.1900], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);
            }

            // Fix per mappa grigia: forza refresh dopo render
            setTimeout(() => {
                map.invalidateSize();
            }, 300);

            markers.forEach(m => map.removeLayer(m)); markers = [];
            const unis = UNI_MAPPING[document.getElementById('map-select').value] || [];

            renderUniList(unis);

            unis.forEach(u => {
                let c = MILANO_DB[u];
                if (c) {
                    let popupContent = `<b>${u}</b><br><a href="${c.url || '#'}" target="_blank" style="color:#2563eb">Visita sito</a>`;
                    markers.push(L.marker([c.lat, c.lon]).addTo(map).bindPopup(popupContent));
                }
            });

            // Zoom sempre su Milano (non troppo dezoomato)
            map.setView([45.4642, 9.1900], 11);
        }
        let myChart;
        init();

        // Inizializza posizione valori slider pagina 3
        document.addEventListener('DOMContentLoaded', function () {
            ['sv_detail', 'sv_risk', 'sv_people', 'sv_abs'].forEach(id => {
                const valueSpan = document.getElementById(id);
                const slider = valueSpan?.parentElement?.querySelector('input[type="range"]');
                if (slider && valueSpan) {
                    positionSliderValue(slider, valueSpan);
                }
            });
        });
    </script>

    <!-- CHATBOT LOGIC -->
    <script>
        let chatHistory = []; // Memoria della conversazione

        function toggleChatAccordion() {
            const content = document.getElementById('chat-accordion-content');
            const arrow = document.getElementById('chat-arrow');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'flex';
                content.style.height = 'auto'; // Lascia che il contenuto definisca l'altezza
                arrow.style.transform = 'rotate(180deg)';
                // Scrolla leggermente per mostrare la chat se necessario
                setTimeout(() => {
                    content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                content.style.display = 'none';
                content.style.height = '0';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function getUserContext() {
            let context = "DATI UTENTE:\n";

            // 1. Scuola (Controllo se esiste l'elemento)
            const schoolEl = document.getElementById('school-select');
            if (schoolEl && schoolEl.value) {
                context += `- Scuola di provenienza: ${schoolEl.value}\n`;
            }

            // 2. Risposte Questionnaire
            const radios = ['q_tech', 'q_biz', 'q_sci', 'q_art', 'q_youtube', 'q_netflix', 'q_startup', 'q_broken', 'q_future'];
            radios.forEach(r => {
                const el = document.querySelector(`input[name="${r}"]:checked`);
                if (el) {
                    // Controllo difensivo per evitare crash se closest non trova nulla
                    const labelEl = el.closest('label');
                    const labelText = labelEl ? labelEl.textContent.trim() : "N/A";
                    context += `- Domanda ${r}: ${labelText} (${el.value})\n`;
                }
            });

            // 3. Checkbox conferme
            const checkboxes = ['chk_teach', 'chk_nature', 'chk_money', 'chk_care', 'chk_sport', 'chk_write', 'chk_law', 'chk_tech', 'chk_politics', 'chk_art'];
            let checks = [];
            checkboxes.forEach(c => {
                const el = document.getElementById(c);
                if (el && el.checked) {
                    const labelEl = el.closest('label');
                    if (labelEl) checks.push(labelEl.textContent.trim());
                }
            });
            if (checks.length > 0) context += `- Interessi confermati: ${checks.join(', ')}\n`;

            // 4. Risultati (Protezione massima)
            if (typeof window.scores !== 'undefined' && document.getElementById('w_name')) {
                // Ordina i punteggi
                let sorted = Object.entries(window.scores).sort((a, b) => b[1] - a[1]);
                // Prendi solo i primi 3 se esistono
                let top3 = sorted.slice(0, 3).map(x => `${x[0]} (${Math.round(x[1])})`).join(", ");

                const winnerName = document.getElementById('w_name').innerText;

                // Aggiungi al contesto solo se c'√® un vincitore reale
                if (winnerName && winnerName.length > 0) {
                    context += `- Risultato vincente: ${winnerName}\n`;
                    context += `- Top 3 facolt√†: ${top3}\n`;
                }
            } else {
                context += "(L'utente sta ancora svolgendo il test)";
            }

            return context;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // 1. Mostra messaggio utente
            appendMessage(msg, 'user');
            input.value = "";

            // 2. Mostra "Sta scrivendo..."
            const loadingId = appendMessage("Sto pensando...", 'ai', true);

            // 3. Raccogli i dati del contesto
            const contextData = getUserContext();

            try {
                // 4. Chiama la TUA API su Vercel
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        history: chatHistory,
                        context: contextData
                    })
                });

                const data = await response.json();

                // 5. Rimuovi loading e mostra risposta
                document.getElementById(loadingId).remove();

                if (data.error) {
                    appendMessage("Errore: " + data.error, 'ai');
                } else if (data.reply) {
                    appendMessage(data.reply, 'ai');
                    // 6. Aggiorna cronologia
                    chatHistory.push({ role: "user", parts: [{ text: msg }] });
                    chatHistory.push({ role: "model", parts: [{ text: data.reply }] });
                } else {
                    appendMessage("Non ho capito, riprova.", 'ai');
                }

            } catch (err) {
                const el = document.getElementById(loadingId);
                if (el) el.innerText = "Errore di connessione üòî";
                console.error(err);
            }
        }

        function appendMessage(text, sender, isLoading = false) {
            const div = document.createElement('div');
            div.innerText = text;
            div.style.padding = "12px 16px";
            div.style.maxWidth = "85%";
            div.style.fontSize = "0.95rem";
            div.style.lineHeight = "1.5";
            div.style.border = "1px solid transparent";

            // Check dark mode
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (sender === 'user') {
                div.style.background = "#6366f1";
                div.style.color = "white";
                div.style.borderRadius = "12px 12px 0 12px";
                div.style.alignSelf = "flex-end";
                div.style.boxShadow = "0 2px 5px rgba(99, 102, 241, 0.2)";
            } else {
                div.classList.add('msg-ai');
                if (isDark) {
                    div.style.background = isLoading ? "rgba(15, 23, 42, 0.8)" : "rgba(30, 41, 59, 0.9)";
                    div.style.color = isLoading ? "#94a3b8" : "#f1f5f9";
                    div.style.borderColor = "rgba(71, 85, 105, 0.6)";
                } else {
                    div.style.background = isLoading ? "#f8fafc" : "white";
                    div.style.color = isLoading ? "#94a3b8" : "#1e293b";
                    div.style.borderColor = "#e2e8f0";
                }
                div.style.borderRadius = "12px 12px 12px 0";
                div.style.alignSelf = "flex-start";
                div.style.boxShadow = "0 2px 4px rgba(0,0,0,0.02)";
                if (isLoading) div.style.fontStyle = "italic";
            }

            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            div.id = "msg-" + Date.now();
            return div.id;
        }

        // --- GOOGLE SHEETS INTEGRATION ---
        function collectFeedbackData() {
            const ratingEl = document.querySelector('input[name="fb_rating"]:checked');
            const rating = ratingEl ? ratingEl.value : "";
            const comment = document.getElementById('fb_comment').value.trim();

            // Raccogli voti e fatica materie
            const gradesInputs = document.querySelectorAll('#subjects-container input[type="range"]');
            let gradesMap = {};
            gradesInputs.forEach(i => {
                const id = i.dataset.id;
                if (!gradesMap[id]) gradesMap[id] = {};
                if (i.dataset.type === 'vote') gradesMap[id].vote = parseInt(i.value);
                if (i.dataset.type === 'effort') gradesMap[id].effort = parseInt(i.value);
            });
            // Converti in array leggibile
            const grades = Object.entries(gradesMap).map(([id, vals]) => ({
                id: id,
                vote: vals.vote || 6,
                effort: vals.effort || 5
            }));

            return {
                timestamp: new Date().toISOString(),
                winner: (window.allSorted && window.allSorted.length > 0) ? window.allSorted[0][0] : "N/D",
                winnerScore: (window.allSorted && window.allSorted.length > 0) ? Math.round(window.allSorted[0][1]) : 0,
                alternatives: (window.recommended || []).slice(1).map(r => ({ name: r[0], score: Math.round(r[1]) })),
                answers: {
                    school: document.getElementById('school-select').value,
                    grades: grades,
                    q_tech: getRadioSafe('q_tech'),
                    q_biz: getRadioSafe('q_biz'),
                    q_sci: getRadioSafe('q_sci'),
                    q_art: getRadioSafe('q_art'),
                    q_youtube: getRadioSafe('q_youtube'),
                    q_netflix: getRadioSafe('q_netflix'),
                    q_startup: getRadioSafe('q_startup'),
                    q_broken: getRadioSafe('q_broken'),
                    q_future: getRadioSafe('q_future'),
                    checks: ['chk_teach', 'chk_nature', 'chk_money', 'chk_care', 'chk_sport', 'chk_write', 'chk_law', 'chk_tech', 'chk_politics', 'chk_art']
                        .filter(id => document.getElementById(id).checked)
                },
                feedbackRating: rating,
                feedbackComment: comment
            };
        }

        async function sendToGoogleSheets(data) {
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyROkQIn8FhDZq8b-UK04F7SzY3VkgFKwtowey7r4vJi0CmFP1tp0LqdmZasRFLulCx/exec";
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
        }

        function submitFeedback() {
            const btn = document.getElementById('btn-feedback');
            const ratingEl = document.querySelector('input[name="fb_rating"]:checked');
            if (!ratingEl) {
                alert("Per favore, dai un voto al quiz prima di inviare.");
                return;
            }
            // Invia in background senza attendere risposta
            const data = collectFeedbackData();
            sendToGoogleSheets(data).catch(err => console.error(err));
            // Mostra conferma sul bottone
            btn.disabled = true;
            btn.innerText = "Feedback inviato, grazie! ‚ú®";
            // Chiudi modale dopo 0.5 secondi
            setTimeout(() => {
                document.getElementById('feedback-overlay').classList.remove('show');
                // Reset bottone per eventuale riapertura
                btn.disabled = false;
                btn.innerText = "Invia Feedback ‚ú®";
            }, 800);
        }

        function closeFeedback() {
            // Invia dati in background anche se chiude
            const data = collectFeedbackData();
            sendToGoogleSheets(data).catch(err => console.error(err));
            // Chiudi subito
            document.getElementById('feedback-overlay').classList.remove('show');
        }

        function getRadioSafe(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : null;
        }

        // Force scroll to top on reload
        if (history.scrollRestoration) {
            history.scrollRestoration = 'manual';
        }
        window.scrollTo(0, 0);
    </script>
</body>

</html>